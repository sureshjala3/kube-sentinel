name: deploy test env

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

on:
  workflow_run:
    workflows: ["Build and Push Preview Docker Image"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    name: Deploy Test Env
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.repository_owner == 'pixelvide' }}

    steps:
      - name: restart kube-sentinel deployment
        env:
          KUBE_SENTINEL_HOST: ${{ secrets.KUBE_SENTINEL_TEST_HOST }}
          KUBE_SENTINEL_AUTH: ${{ secrets.KUBE_SENTINEL_TEST_AUTH }}
        run: |
          if [ -z "$KUBE_SENTINEL_HOST" ] || [ -z "$KUBE_SENTINEL_AUTH" ]; then
            echo "KUBE_SENTINEL_HOST or KUBE_SENTINEL_AUTH is not set. Skipping deployment."
            exit 0
          fi
          RESTART_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          curl -X PATCH "$KUBE_SENTINEL_HOST/api/v1/deployments/kube-sentinel/kube-sentinel" \
            -H "Authorization: $KUBE_SENTINEL_AUTH" \
            -H "Content-Type: application/json" \
            -d "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"kube-sentinel.kubernetes.io/restartedAt\":\"$RESTART_TIME\"}}}}}"
